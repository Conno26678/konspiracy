<!DOCTYPE html>
<html lang="en">
    
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Panel</title>
</head>

<body>
    <h1>Welcome Teacher</h1>
    <div id="time"></div>
    <form id="quiz-form" method="POST" action="/teacher">
        <label for="subject">Choose a subject for the test:</label>
        <select id="subject" name="selectedQuiz">
            <option value="Colors">Colors</option>
            <option value="Numbers">Numbers</option>
            <option value="Letters">Letters</option>
        </select>
        <button type="button" id="view-quiz">View Quiz</button>
        <div id="time"></div>
        <button style="display: none;" type="button" onclick="countdown()" id="ready-button">Ready</button>
        <% students.forEach(student=> { %>
            <ul>
                <%= student %>
            </ul>
            <% }) %>
    </form>
    
    <div id="quiz-container" style="display: none;">
        <h2 id="quiz-title"></h2>
        <div id="questions"></div>
    </div>
    
    <button id="ready">Ready</button>
    <div>
        <h3>Active Students in Your Classes:</h3>
        <ul id="students">
            <% students.forEach(student=> { %>
                <li>
                    <%= student %>
                </li>
                <% }) %>
            </ul>
        </div>
        
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Quiz data
        const quizzes = {
            Colors: {
                title: "Colors Quiz",
                questions: [
                    "What is the first color of the rainbow?",
                    "What color is also the color of a fruit?",
                    "What color is the sun?"
                ],
                answers: [
                    { "Red": true, "Orange": false, "Purple": false, "Blue": false },
                    { "Yellow": false, "Green": false, "Orange": true, "Violet": false },
                    { "Red": false, "Yellow": true, "Pink": false, "Blue": false }
                ]
            },
            Numbers: {
                title: "Numbers Quiz",
                questions: [
                    "What is 6 + 7?",
                    "What is 9 + 10?",
                    "What is 6 + 9?"
                ],
                answers: [
                    { "67": false, "14": false, "12": false, "13": true },
                    { "21": false, "910": false, "19": true, "1": false },
                    { "69": false, "15": true, "3": false, "16": false }
                ]
            },
            Letters: {
                title: "Letters Quiz",
                questions: [
                    "Which of these letters is a vowel?",
                    "What is the 13th letter of the alphabet?",
                    "Which letter does 'sea' sound like?"
                ],
                answers: [
                    { "C": false, "B": false, "D": false, "A": true },
                    { "L": false, "M": true, "N": false, "O": false },
                    { "C": true, "B": false, "S": false, "V": false }
                ]
            }
        };

        const subjectDropdown = document.getElementById("subject");
        const quizContainer = document.getElementById("quiz-container");
        const quizTitle = document.getElementById("quiz-title");
        const questionsDiv = document.getElementById("questions");
        const viewQuizButton = document.getElementById("view-quiz");
        // const confirmQuizButton = document.getElementById("confirm-quiz");
        // const selectedQuizInput = document.getElementById("selectedQuiz");

        viewQuizButton.addEventListener("click", function () {
            document.getElementById("ready-button").style.display = "inline-block";
            const selectedSubject = subjectDropdown.value;

            // Clear previous quiz
            questionsDiv.innerHTML = "";

            // Display the selected quiz
            if (quizzes[selectedSubject]) {
                const quiz = quizzes[selectedSubject];
                quizTitle.textContent = quiz.title;

                quiz.questions.forEach((question, index) => {
                    const questionElement = document.createElement("p");
                    questionElement.textContent = `${index + 1}. ${question}`;
                    questionsDiv.appendChild(questionElement);

                    const answers = quiz.answers[index];
                    for (const [answer, isCorrect] of Object.entries(answers)) {
                        const answerElement = document.createElement("div");
                        answerElement.innerHTML = `
                            <label>
                                <input type="radio" name="q${index}" value="${answer}" disabled>
                                ${answer}
                            </label>
                        `;
                        questionsDiv.appendChild(answerElement);
                    }
                });

                quizContainer.style.display = "block";
                confirmQuizButton.style.display = "inline-block";

                selectedQuizInput.value = selectedSubject;
            }
        });

        const socket = io();
        let timer = null;

        // Button click - send to server
        document.getElementById('ready').onclick = () => {
            socket.emit('start-countdown');
        };

        // Start countdown when server says so
        socket.on('countdown-start', (data) => {
            let remaining = Math.ceil((data.endTime - Date.now()) / 1000);

            timer = setInterval(() => {
                document.getElementById('time').innerText = remaining;
                remaining--;
                if (remaining < 0) {
                    clearInterval(timer);
                }
            }, 1000);
        });

        // Sync countdown if joining late
        socket.on('countdown:sync', (data) => {
            let remaining = data.remaining;

            timer = setInterval(() => {
                document.getElementById('time').innerText = remaining;
                remaining--;
                if (remaining < 0) {
                    clearInterval(timer);
                }
            }, 1000);
        });

        // Clear when done
        socket.on('countdown-done', () => {
            document.getElementById('time').innerText = '';
            if (timer) clearInterval(timer);
            alert('Question?')
        });

        // Update student list
        socket.on('update-students', (students) => {
            const studentList = document.getElementById('students');
            studentList.innerHTML = '';

            students.forEach(student => {
                const li = document.createElement('li');
                li.textContent = student;
                studentList.appendChild(li);
            });
        });
    </script>
    <div id="time"></div>
    <button onclick="countdown()">Ready</button>
    <% students.forEach(student=> { %>
        <ul>
            <%= student %>
        </ul>
        <% }) %>
        <!-- directs to user page just for testing -->
        <button onclick="location.href='/'">user page</button>
</body>

<script>
    function countdown() {
        let time = 10;
        const interval = setInterval(() => {
            document.getElementById('time').innerText = time;
            time--;
            if (time <= 0) {
                clearInterval(interval);
                document.getElementById('quiz-form').submit(); // Submit the form to /teacher
            }
        }, 1000);
    }
</script>

</html>